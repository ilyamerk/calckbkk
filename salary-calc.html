<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Калькулятор зарплаты</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #FFF6EA; font-family: "Inter", Arial, sans-serif; }
  </style>
</head>
<body>

  <!-- Сам калькулятор -->
  <salary-calculator></salary-calculator>

  <!-- Полный скрипт калькулятора -->
  <script>
class SalaryCalculator extends HTMLElement{
  connectedCallback(){
    const root = this.attachShadow({mode:'open'});
    root.innerHTML = `
<style>
  :host{display:block;font-family:"Inter",Arial,sans-serif;color:#1A1A1A}
  .container{max-width:1100px;margin:0 auto;padding:40px 16px}
  .title-main{font-size:28px;font-weight:800;color:#7A553A;margin:0 0 24px;text-align:center}
  .layout{display:grid;grid-template-columns:1.4fr .9fr;gap:24px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .card{background:#FFFCF6;border:1px solid #E6DCCD;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 6px 18px rgba(0,0,0,.06);padding:24px}
  .result-card{position:sticky;top:24px}
  .section-title{margin:0 0 16px;font-weight:800;font-size:20px;letter-spacing:.2px;color:#7A553A}
  label{display:block;font-weight:600;color:#786B5E;font-size:14px;margin-bottom:8px}
  .field-container{position:relative;display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
  .field{display:none;opacity:0;transform:translateY(6px);transition:opacity .25s ease,transform .25s ease}
  .field.visible{display:block;opacity:1;transform:translateY(0)}
  .field-container input,.field-container select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #E6DCCD;background:#fff;font-size:16px;transition:border-color .2s,box-shadow .2s;box-sizing:border-box}
  /* Бежевый стиль для селекторов Да/Нет */
  select.yn-select{background:#FFF0DC;border-color:#E6DCCD}
  select.yn-select:focus{background:#FFEBD2}
  .field-container input:focus,.field-container select:focus{outline:none;border-color:#DCCBB7;box-shadow:0 0 0 3px rgba(122,85,58,.25)}
  .control-wrap{position:relative;width:100%}
  .control-wrap input[type="number"],.control-wrap select{padding-right:48px}
  .hint-button{position:absolute;right:12px;top:50%;transform:translateY(-50%);width:26px;height:26px;border-radius:50%;background:#7A553A;color:#fff;border:none;cursor:pointer;font-size:14px;display:none;align-items:center;justify-content:center}
  .hint-text{display:none;position:absolute;z-index:10;right:0;top:calc(100% + 6px);background:#fff;color:#1A1A1A;border:1px solid #E6DCCD;border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 6px 18px rgba(0,0,0,.06);max-width:320px}
  .hint-text.visible{display:block}
  .btn{flex:1;min-width:220px;padding:14px 18px;border:1px solid #E6DCCD;border-radius:999px;background:#7A553A;color:#fff;font-weight:800;font-size:16px;cursor:pointer}
  .btn.secondary{background:#fff;color:#1A1A1A}
  .toolbar{display:flex;gap:16px;flex-wrap:wrap;margin-top:24px}
  .section{display:none;margin-top:16px;background:#fff;border:1px solid #E6DCCD;border-radius:16px;padding:24px}
  #result{background:#fff;border:1px solid #E6DCCD;border-radius:16px;padding:24px;color:#7A553A;font-weight:800}
  input[type="range"]{height:36px;background:transparent;-webkit-appearance:none}
  input[type="range"]::-webkit-slider-runnable-track{height:6px;background:#E6DCCD;border-radius:999px}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-7px;width:20px;height:20px;border-radius:50%;background:#7A553A;box-shadow:0 0 0 4px rgba(122,85,58,.15);cursor:pointer}
  input[type="range"]::-moz-range-track{height:6px;background:#E6DCCD;border-radius:999px}
  input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#7A553A;border:none;box-shadow:0 0 0 4px rgba(122,85,58,.15);cursor:pointer}
  .inline-value{margin-left:8px;font-weight:700;color:#1A1A1A;min-width:40px;display:inline-block;text-align:right}
  .custom-select{position:relative}
  .custom-select-toggle{width:100%;padding:12px 44px 12px 14px;border-radius:12px;border:1px solid #E6DCCD;background:#fff;font-size:16px;text-align:left;cursor:pointer}
  .custom-select-toggle::after{content:"";position:absolute;right:16px;top:50%;transform:translateY(-50%);border:6px solid transparent;border-top-color:#786B5E}
  .custom-select-menu{position:absolute;z-index:20;left:0;right:0;margin-top:6px;background:#fff;border:1px solid #E6DCCD;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 6px 18px rgba(0,0,0,.06);max-height:260px;overflow:auto;display:none}
  .custom-select.open .custom-select-menu{display:block}
  .custom-select-search{padding:8px;position:sticky;top:0;background:#fff;border-bottom:1px solid #E6DCCD}
  .custom-select-search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #E6DCCD;background:#fff;font-size:14px}
  .custom-option{padding:10px 12px;cursor:pointer;font-size:16px}
  .custom-option:hover{background:#FFF6EA}
  .custom-option[aria-selected="true"]{background:#F1E6D8;font-weight:700}
  .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;padding:0;border:0;overflow:hidden;clip:rect(0 0 0 0);clip-path:inset(50%);white-space:nowrap}
</style>

<div class="container">
  <h1 class="title-main">Калькулятор зарплаты</h1>
  <div class="layout">
    <main class="pane">
      <div class="card">
        <h2 class="section-title">Выбор роли</h2>
        <label for="role" class="field visible">Должность</label>
        <select id="role" class="visually-hidden" aria-hidden="true">
          <option value="">— Выберите —</option>
          <option value="zam">Заместитель директора</option>
          <option value="povar">Повар</option>
          <option value="others">Старший кассир / Кассир / Бариста / Работник торгового зала / Повар-универсал</option>
          <option value="general">Общий подсчёт</option>
        </select>
        <div class="custom-select" id="roleCustom">
          <button type="button" class="custom-select-toggle" aria-haspopup="listbox" aria-expanded="false">— Выберите —</button>
          <div class="custom-select-menu" role="listbox" tabindex="-1">
            <div class="custom-select-search"><input type="text" placeholder="Поиск должности…" aria-label="Поиск"></div>
            <div class="custom-option" role="option" data-value="">— Выберите —</div>
            <div class="custom-option" role="option" data-value="zam">Заместитель директора</div>
            <div class="custom-option" role="option" data-value="povar">Повар</div>
            <div class="custom-option" role="option" data-value="others">Старший кассир / Кассир / Бариста / Работник торгового зала / Повар-универсал</div>
            <div class="custom-option" role="option" data-value="general">Общий подсчёт</div>
          </div>
        </div>

        <!-- ZAM -->
        <div id="zamFields" class="section">
          <h3 class="section-title">Показатели за месяц</h3>
          <div class="field-container"><label class="field" data-field="zam_to">На сколько процентов был выполнен план по ТО за месяц? (%) <input type="number" id="zam_to" min="0"></label><button class="hint-button" data-hint="zam_to_hint">?</button><div id="zam_to_hint" class="hint-text">% от фактического ТО — это процент выполнения плана по товарообороту за месяц.</div></div>
          <div class="field-container"><label class="field" data-field="zam_tp">На сколько процентов была пройдена проверка Тайного покупателя? (%) <input type="number" id="zam_tp" min="0"></label><button class="hint-button" data-hint="zam_tp_hint">?</button><div id="zam_tp_hint" class="hint-text">Процент прохождения чек-листа тайного покупателя.</div></div>
          <div class="field-container"><label class="field" data-field="zam_ato">Каков процент прохождения АТО+СГИ? (%) <input type="number" id="zam_ato" min="0"></label><button class="hint-button" data-hint="zam_ato_hint">?</button><div id="zam_ato_hint" class="hint-text">АТО+СГИ — показатели аудита и санитарии.</div></div>
          <div class="field-container"><label class="field" data-field="zam_hr">Сколько процентов по HR-индексу? (%) <input type="number" id="zam_hr" min="0"></label><button class="hint-button" data-hint="zam_hr_hint">?</button><div id="zam_hr_hint" class="hint-text">Итоговый HR-индекс за месяц.</div></div>
          <div class="field-container"><label class="field" data-field="zam_feedback">Отрицательные отзывы на 10 000 чеков <input type="number" id="zam_feedback" min="0"></label><button class="hint-button" data-hint="zam_feedback_hint">?</button><div id="zam_feedback_hint" class="hint-text">Количество отрицательных отзывов на 10 000 чеков.</div></div>
        </div>

        <!-- POVAR -->
        <div id="povarFields" class="section">
          <h3 class="section-title">Параметры смены</h3>
          <div class="field-container"><label class="field" data-field="baseRate">Часовая ставка (₽) <input type="number" id="baseRate" min="0"></label><button class="hint-button" data-hint="baseRate_hint">?</button><div id="baseRate_hint" class="hint-text">Ставка без премий.</div></div>
          <div class="field-container"><label class="field" data-field="hours">Длительность смены (часы)
            <div class="slider-container"><input type="range" id="hours" min="0.5" max="24" step="0.5" value="0.5"><span id="povarHoursValue" class="inline-value">0.5</span></div>
          </label><button class="hint-button" data-hint="hours_hint">?</button><div id="hours_hint" class="hint-text">Диапазон 0.5–24.</div></div>
          <div class="field-container"><label class="field" data-field="to">Процент выполнения плана по ТО? (%) <input type="number" id="to" min="0"></label><button class="hint-button" data-hint="to_hint">?</button><div id="to_hint" class="hint-text">Соотношение фактической к плановой выручке.</div></div>
          <div class="field-container"><label class="field" data-field="povar_has_checklist">Была ли проверка чек-листа?
            <select id="povar_has_checklist" class="yn-select"><option value="">— Выберите —</option><option value="yes">Да</option><option value="no">Нет/Не знаю</option></select>
          </label><button class="hint-button" data-hint="povar_has_checklist_hint">?</button><div id="povar_has_checklist_hint" class="hint-text">Проверка чек-листа Шеф-повара.</div></div>
          <div class="field-container" id="povar_checklist_container"><label class="field" data-field="checklist">Процент чек-листа за смену? (%) <input type="number" id="checklist" min="0"></label><button class="hint-button" data-hint="checklist_hint">?</button><div id="checklist_hint" class="hint-text">Общий процент прохождения.</div></div>
          <div class="field-container"><label class="field" data-field="povar_has_ovk">Была ли проверка по униформе (ОВК)?
            <select id="povar_has_ovk" class="yn-select"><option value="">— Выберите —</option><option value="yes">Да</option><option value="no">Нет/Не знаю</option></select>
          </label><button class="hint-button" data-hint="povar_has_ovk_hint">?</button><div id="povar_has_ovk_hint" class="hint-text">Проверка ОВК.</div></div>
          <div class="field-container" id="povar_ovk_container"><label class="field" data-field="ovk">Процент ОВК за смену? (%) <input type="number" id="ovk" min="0"></label><button class="hint-button" data-hint="ovk_hint">?</button><div id="ovk_hint" class="hint-text">Процент выполнения ОВК.</div></div>
          <div class="field-container"><label class="field" data-field="povar_has_ato">Была ли проверка АТО + СГИ?
            <select id="povar_has_ato" class="yn-select"><option value="">— Выберите —</option><option value="yes">Да</option><option value="no">Нет/Не знаю</option></select>
          </label><button class="hint-button" data-hint="povar_has_ato_hint">?</button><div id="povar_has_ato_hint" class="hint-text">Проверка АТО+СГИ.</div></div>
          <div class="field-container" id="povar_ato_container"><label class="field" data-field="ato">Процент АТО+СГИ за месяц? (%) <input type="number" id="ato" min="0"></label><button class="hint-button" data-hint="ato_hint">?</button><div id="ato_hint" class="hint-text">Процент выполнения за месяц.</div></div>
        </div>

        <!-- OTHERS -->
        <div id="othersFields" class="section">
          <h3 class="section-title">Смена и показатели</h3>
          <div class="field-container"><label class="field" data-field="others_hourly_rate">Часовая ставка (₽) <input type="number" id="others_hourly_rate" min="0"></label><button class="hint-button" data-hint="others_hourly_rate_hint">?</button><div id="others_hourly_rate_hint" class="hint-text">Сумма за час.</div></div>
          <div class="field-container"><label class="field" data-field="others_shift_length">Длительность смены (часы)
            <div class="slider-container"><input type="range" id="others_shift_length" min="0.5" max="24" step="0.5" value="0.5"><span id="othersShiftValue" class="inline-value">0.5</span></div>
          </label><button class="hint-button" data-hint="others_shift_length_hint">?</button><div id="others_shift_length_hint" class="hint-text">Диапазон 0.5–24.</div></div>
          <div class="field-container"><label class="field" data-field="others_to">Товарооборот за день (₽) <input type="number" id="others_to" min="0"></label><button class="hint-button" data-hint="others_to_hint">?</button><div id="others_to_hint" class="hint-text">Сумма выручки за день.</div></div>
          <div class="field-container"><label class="field" data-field="others_to_percent">Выполнение плана по ТО (%) <input type="number" id="others_to_percent" min="0"></label><button class="hint-button" data-hint="others_to_percent_hint">?</button><div id="others_to_percent_hint" class="hint-text">Факт/план в процентах.</div></div>
          <div class="field-container"><label class="field" data-field="others_has_tp">Была ли проверка от Тайного покупателя?
            <select id="others_has_tp" class="yn-select"><option value="">— Выберите —</option><option value="yes">Да</option><option value="no">Нет/Не знаю</option></select>
          </label><button class="hint-button" data-hint="others_has_tp_hint">?</button><div id="others_has_tp_hint" class="hint-text">Была ли проверка ТП.</div></div>
          <div class="field-container" id="others_tp_container"><label class="field" data-field="others_tp">Процент проверки ТП (%) <input type="number" id="others_tp" min="0"></label><button class="hint-button" data-hint="others_tp_hint">?</button><div id="others_tp_hint" class="hint-text">Процент прохождения чек-листа.</div></div>
          <div class="field-container"><label class="field" data-field="others_complaints">Подтверждённые отрицательные отзывы <input type="number" id="others_complaints" min="0"></label><button class="hint-button" data-hint="others_complaints_hint">?</button><div id="others_complaints_hint" class="hint-text">Количество за смену.</div></div>
          <div class="field-container"><label class="field" data-field="others_has_ato">Было ли прохождение АТО + СГИ?
            <select id="others_has_ato" class="yn-select"><option value="">— Выберите —</option><option value="yes">Да</option><option value="no">Нет/Не знаю</option></select>
          </label><button class="hint-button" data-hint="others_has_ato_hint">?</button><div id="others_has_ato_hint" class="hint-text">Была ли проверка АТО+СГИ.</div></div>
          <div class="field-container" id="others_ato_container"><label class="field" data-field="others_ato">Процент АТО+СГИ (%) <input type="number" id="others_ato" min="0"></label><button class="hint-button" data-hint="others_ato_hint">?</button><div id="others_ato_hint" class="hint-text">Процент выполнения.</div></div>
          <div class="field-container"><label class="field" data-field="others_total_hours">Общее количество часов команды (часы) <input type="number" id="others_total_hours" min="1"></label><button class="hint-button" data-hint="others_total_hours_hint">?</button><div id="others_total_hours_hint" class="hint-text">Сумма часов всей команды.</div></div>
        </div>

        <!-- GENERAL -->
        <div id="generalFields" class="section">
          <h3 class="section-title">План на месяц</h3>
          <div class="field-container"><label class="field" data-field="general_rate">Часовая ставка (₽) <input type="number" id="general_rate" min="0"></label><button class="hint-button" data-hint="general_rate_hint">?</button><div id="general_rate_hint" class="hint-text">Ставка без премий.</div></div>
          <div class="field-container"><label class="field" data-field="general_shifts">Дней в месяце
            <div class="slider-container"><input type="range" id="general_shifts" min="1" max="31" step="1" value="1"><span id="shiftValue" class="inline-value">1</span></div>
          </label><button class="hint-button" data-hint="general_shifts_hint">?</button><div id="general_shifts_hint" class="hint-text">1–31.</div></div>
          <div class="field-container"><label class="field" data-field="general_hours">Часов в день
            <div class="slider-container"><input type="range" id="general_hours" min="0.5" max="24" step="0.5" value="0.5"><span id="hoursValue" class="inline-value">0.5</span></div>
          </label><button class="hint-button" data-hint="general_hours_hint">?</button><div id="general_hours_hint" class="hint-text">0.5–24.</div></div>
        </div>

        <div class="toolbar">
          <button class="btn" id="calcTop">Рассчитать</button>
          <button class="btn secondary" id="copyBtnTop">Копировать данные</button>
        </div>
      </div>
    </main>
    <aside class="pane result-card"><div id="result">Результат появится после расчёта.</div></aside>
  </div>

  <div class="toolbar" style="margin-top:16px">
    <button class="btn" id="calcBottom">Рассчитать</button>
    <button class="btn secondary" id="copyBtnBottom">Копировать данные</button>
  </div>
</div>
`;

    // ===== JS =====
    const $ = id => root.getElementById(id);
    const qs = (sel, ctx=root) => ctx.querySelector(sel);
    const qsa = (sel, ctx=root) => Array.from(ctx.querySelectorAll(sel));

    function toggleHint(id){const el=$(id); if(!el) return; el.classList.toggle('visible');}

    function mountHintButtonsInsideInputs(){
      qsa('.field-container').forEach(fc=>{
        const btn = fc.querySelector('.hint-button');
        const label = fc.querySelector('label.field');
        if(!btn || !label) return;
        const slider = label.querySelector('slider-container');
        const ctrl = label.querySelector('input, select') || null;
        const sl = label.querySelector('.slider-container');
        const finalCtrl = sl || ctrl;
        if(!finalCtrl) return;
        let wrap = finalCtrl.closest('.control-wrap');
        if(!wrap){wrap = document.createElement('div'); wrap.className='control-wrap'; finalCtrl.parentNode.replaceChild(wrap, finalCtrl); wrap.appendChild(finalCtrl);}
        wrap.appendChild(btn); btn.style.display='inline-flex';
        const hid = btn.getAttribute('data-hint'); if(hid){btn.addEventListener('click', ()=>toggleHint(hid));}
      });
    }

    const deps = {
      povar_has_checklist:{container:'povar_checklist_container', input:'checklist'},
      povar_has_ovk:{container:'povar_ovk_container', input:'ovk'},
      povar_has_ato:{container:'povar_ato_container', input:'ato'},
      others_has_tp:{container:'others_tp_container', input:'others_tp'},
      others_has_ato:{container:'others_ato_container', input:'others_ato'}
    };

    function resetSection(section){
      section.style.display='none';
      qsa('.field', section).forEach(f=>f.classList.remove('visible'));
      qsa('.hint-button', section).forEach(b=>{b.style.display='none'});
      qsa('input[type="number"]', section).forEach(i=>i.value='');
      qsa('select', section).forEach(s=>s.value='');
      qsa('input[type="range"]', section).forEach(r=>{
        r.value=r.min; const span=r.parentElement.querySelector('span'); if(span){span.textContent = r.step && String(r.step).includes('.') ? parseFloat(r.value).toFixed(1) : r.value;}
      });
      Object.values(deps).forEach(d=>{ const c=$(d.container); if(c) c.style.display='none'; });
    }

    function showRoleSection(role){
      const sec=$(role+'Fields'); if(!sec) return;
      sec.style.display='block';
      const first=qs('.field', sec);
      if(first){ first.classList.add('visible'); const btn=first.parentElement.querySelector('.hint-button'); if(btn){ btn.style.display='inline-flex'; } }
    }

    function toggleDependent(selectId){
      const cfg=deps[selectId]; if(!cfg) return;
      const sel=$(selectId), cont=$(cfg.container), inp=$(cfg.input); if(!sel||!cont) return;
      const yes=sel.value==='yes';
      cont.style.display = yes ? 'block' : 'none';
      const field=cont.querySelector('.field'); const btn=cont.querySelector('.hint-button');
      if(yes){ field&&field.classList.add('visible'); if(btn){ btn.style.display='inline-flex'; } }
      else { field&&field.classList.remove('visible'); if(btn){ btn.style.display='none'; } if(inp){ const el=$(inp); if(el) el.value=''; } }
    }

    function revealNextIfValid(sectionId, currentFieldId){
      const sec=$(sectionId); if(!sec) return;
      const fields=qsa('.field', sec);
      const cur=qs('[data-field="'+currentFieldId+'"]', sec); if(!cur) return;
      const input=cur.querySelector('input, select'); if(!input) return;
      let valid=false;
      if(input.tagName==='SELECT'){ valid = input.value!==''; }
      else if(input.type==='range'){ valid = input.value!=='' && parseFloat(input.value)>=parseFloat(input.min||'0'); }
      else { valid = input.value!=='' && !isNaN(parseFloat(input.value)) && parseFloat(input.value)>=0; }
      Object.values(deps).forEach(cfg=>{
        if(currentFieldId===cfg.input){
          const parentSel = Object.keys(deps).find(k=>deps[k].input===cfg.input);
          const sel=$(parentSel);
          if(sel && sel.value!=='yes') valid=false;
        }
      });
      const idx=fields.indexOf(cur);
      if(valid){
        input.classList.remove('error');
        for(let i=idx+1;i<fields.length;i++){
          const f=fields[i];
          const name=f.getAttribute('data-field')||'';
          const block=Object.keys(deps).some(sid=>{ const c=deps[sid]; return name===c.input && $(sid) && $(sid).value!=='yes'; });
          if(block) continue;
          f.classList.add('visible');
          const b=f.parentElement.querySelector('.hint-button'); if(b){ b.style.display='inline-flex'; }
          break;
        }
      } else {
        input.classList.add('error');
        for(let i=idx+1;i<fields.length;i++){
          const f=fields[i];
          f.classList.remove('visible');
          const b=f.parentElement.querySelector('.hint-button'); if(b){ b.style.display='none'; }
          const ni=f.querySelector('input, select');
          if(ni){
            if(ni.tagName==='SELECT') ni.value='';
            else if(ni.type==='range'){
              ni.value=ni.min; const s=ni.parentElement.querySelector('span'); if(s) s.textContent = ni.step && String(ni.step).includes('.') ? parseFloat(ni.value).toFixed(1) : ni.value;
            } else ni.value='';
          }
        }
      }
    }

    function toggleRoleFields(){
      qsa('.section').forEach(resetSection);
      $('result').innerHTML='Результат появится после расчёта.';
      const role = $('role').value; if(!role) return;
      showRoleSection(role);
      Object.keys(deps).forEach(id=>{ const el=$(id); if(el) toggleDependent(id); });
    }

    function bindProgressiveReveal(){
      qsa('input[type="number"], input[type="range"], select').forEach(el=>{
        const handler=()=>{
          const section=el.closest('.section'); if(!section || section.style.display==='none') return;
          if(el.type==='range'){
            const span=el.parentElement && el.parentElement.querySelector('span');
            if(span){ span.textContent = el.step && String(el.step).includes('.') ? parseFloat(el.value).toFixed(1) : el.value; }
          }
          if(deps[el.id]) toggleDependent(el.id);
          const df = el.closest('.field')?.getAttribute('data-field'); if(df) revealNextIfValid(section.id, df);
        };
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
      });
    }

    function copyData(){
      const role=$('role').value; if(!role){ alert('Пожалуйста, выберите должность.'); return; }
      let dataText=[], fields=[];
      if(role==='zam'){ fields=[{id:'zam_to',label:'Процент выполнения плана по ТО (%)'},{id:'zam_tp',label:'Процент проверки Тайного покупателя (%)'},{id:'zam_ato',label:'Процент прохождения АТО+СГИ (%)'},{id:'zam_hr',label:'Процент HR-индекса (%)'},{id:'zam_feedback',label:'Отрицательные отзывы на 10 000 чеков'}]; }
      else if(role==='povar'){ fields=[{id:'baseRate',label:'Часовая ставка (₽)'},{id:'hours',label:'Длительность смены (часы)'},{id:'to',label:'Процент выполнения плана по ТО (%)'},{id:'povar_has_checklist',label:'Была ли проверка чек-листа?'},{id:'checklist',label:'Процент прохождения чек-листа Шеф-повара (%)'},{id:'povar_has_ovk',label:'Была ли проверка по униформе (ОВК)?'},{id:'ovk',label:'Процент проверки по униформе (ОВК) (%)'},{id:'povar_has_ato',label:'Была ли проверка АТО + СГИ?'},{id:'ato',label:'Процент прохождения АТО+СГИ (%)'}]; }
      else if(role==='others'){ fields=[{id:'others_hourly_rate',label:'Часовая ставка (₽)'},{id:'others_shift_length',label:'Длительность смены (часы)'},{id:'others_to',label:'Товарооборот за день (₽)'},{id:'others_to_percent',label:'Процент выполнения плана по ТО (%)'},{id:'others_has_tp',label:'Была ли проверка от Тайного покупателя?'},{id:'others_tp',label:'Процент проверки Тайного покупателя (%)'},{id:'others_complaints',label:'Подтверждённые отрицательные отзывы'},{id:'others_has_ato',label:'Было ли прохождение АТО + СГИ?'},{id:'others_ato',label:'Процент прохождения АТО+СГИ (%)'},{id:'others_total_hours',label:'Общее количество часов команды (часы)'}]; }
      else if(role==='general'){ fields=[{id:'general_rate',label:'Часовая ставка (₽)'},{id:'general_shifts',label:'Количество дней в месяце'},{id:'general_hours',label:'Часов в день'}]; }

      const roleText = qs('#roleCustom .custom-select-toggle').textContent;
      dataText.push(\`Должность: \${roleText.trim()}\`);
      dataText.push('Введённые данные:');
      let hasData=false;
      fields.forEach(field=>{
        const input=$(field.id);
        if(input && input.value
          && !(field.id==='others_tp' && $('others_has_tp').value==='no')
          && !(field.id==='others_ato' && $('others_has_ato').value==='no')
          && !(field.id==='checklist' && $('povar_has_checklist').value==='no')
          && !(field.id==='ovk' && $('povar_has_ovk').value==='no')
          && !(field.id==='ato' && $('povar_has_ato').value==='no')){
          let value=input.value;
          if(field.id==='hours' || field.id==='others_shift_length' || field.id==='general_hours'){ value=parseFloat(value).toFixed(1); }
          dataText.push(\`\${field.label}: \${value}\`); hasData=true;
        }
      });
      const resultDiv=$('result');
      if(resultDiv.innerText && !/Ошибка|Пожалуйста, выберите должность/.test(resultDiv.innerText)){
        dataText.push(''); dataText.push('Результат расчёта:'); dataText.push(resultDiv.innerText.trim());
      }
      if(hasData || (resultDiv.innerText && !/Ошибка|Пожалуйста, выберите должность/.test(resultDiv.innerText))){
        try{
          const finalText=dataText.join('\n')+'\n';
          navigator.clipboard?.writeText(finalText).then(()=>alert('Данные и результат скопированы в буфер обмена!')).catch(()=>{
            const ta=document.createElement('textarea'); ta.value=finalText; root.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Данные и результат скопированы в буфер обмена!');
          });
        }catch(e){ alert('Ошибка при копировании данных.'); }
      } else { alert('Нет данных или результата для копирования.'); }
    }

    function calculateSalary(){
      const role=$('role').value;
      const resultDiv=$('result');
      resultDiv.innerHTML='';
      if(!role){ resultDiv.innerHTML = "<p style='color:red;'>Ошибка расчёта, проверьте введённые значения</p>"; return; }

      let inputs=[];
      if(role==='zam'){ inputs=['zam_to','zam_tp','zam_ato','zam_hr','zam_feedback'].map($); }
      else if(role==='povar'){ inputs=['baseRate','hours','to','povar_has_checklist','checklist','povar_has_ovk','ovk','povar_has_ato','ato'].map($); }
      else if(role==='others'){ inputs=['others_hourly_rate','others_shift_length','others_to','others_to_percent','others_has_tp','others_tp','others_complaints','others_has_ato','others_ato','others_total_hours'].map($); }
      else if(role==='general'){ inputs=['general_rate','general_shifts','general_hours'].map($); }

      let hasError=false;
      for(const input of inputs){
        if(!input) continue;
        if((['others_has_tp','others_has_ato','povar_has_checklist','povar_has_ovk','povar_has_ato'].includes(input.id)) && !input.value){ input.classList.add('error'); hasError=true; }
        else if(!['others_tp','others_has_tp','others_ato','others_has_ato','checklist','povar_has_checklist','ovk','povar_has_ovk','ato','povar_has_ato'].includes(input.id) && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else if(input.id==='others_tp' && $('others_has_tp').value==='yes' && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else if(input.id==='others_ato' && $('others_has_ato').value==='yes' && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else if(input.id==='checklist' && $('povar_has_checklist').value==='yes' && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else if(input.id==='ovk' && $('povar_has_ovk').value==='yes' && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else if(input.id==='ato' && $('povar_has_ato').value==='yes' && (!input.value || parseFloat(input.value) < 0)){ input.classList.add('error'); hasError=true; }
        else { input.classList.remove('error'); }
      }
      if(hasError){ resultDiv.innerHTML = "<p style='color:red;'>Ошибка расчёта, проверьте введённые значения</p>"; return; }

      let resultHTML='';
      if(role==='zam'){
        const to=parseFloat($('zam_to').value);
        const tp=parseFloat($('zam_tp').value);
        const ato=parseFloat($('zam_ato').value);
        const hr=parseFloat($('zam_hr').value);
        const feedback=parseFloat($('zam_feedback').value);

        let bonusTO = to >= 95 && to < 98 ? 5000 : to >= 98 && to <= 102.9 ? 10000 : to > 102.9 ? 15000 : 0;
        let bonusTP = tp >= 85 && tp < 90 ? 1500 : tp >= 90 ? 3000 : 0;
        let bonusATO = ato >= 85 && ato <= 95 ? 1500 : ato > 95 ? 3000 : 0;
        let bonusHR = hr >= 80 && hr <= 85 ? 2000 : hr > 85 ? 4000 : 0;
        let bonusFeedback = feedback > 3 && feedback < 6 ? 1500 : feedback <= 3 ? 3000 : 0;
        const totalBonus=bonusTO+bonusTP+bonusATO+bonusHR+bonusFeedback;

        resultHTML = `
        <div class="result-section"><h3>Расчёт премий</h3>
          <div class="result-item"><span>Премия за ТО (%: ${to}%)</span><strong>${bonusTO.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Премия за Тайного покупателя (%: ${tp}%)</span><strong>${bonusTP.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Премия за АТО+СГИ (%: ${ato}%)</span><strong>${bonusATO.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Премия за HR-индекс (%: ${hr}%)</span><strong>${bonusHR.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Премия за отзывы (на 10 000 чеков: ${feedback})</span><strong>${bonusFeedback.toFixed(0)} ₽</strong></div>
        </div>
        <hr /><div class="result-total">Общая премия: <strong>${totalBonus.toFixed(0)} ₽</strong></div>`;
      }
      else if(role==='povar'){
        const baseRate=parseFloat($('baseRate').value);
        const to=parseFloat($('to').value);
        const checklist=$('povar_has_checklist').value==='yes'?parseFloat($('checklist').value):0;
        const ovk=$('povar_has_ovk').value==='yes'?parseFloat($('ovk').value):0;
        const ato=$('povar_has_ato').value==='yes'?parseFloat($('ato').value):0;
        const hours=parseFloat($('hours').value);

        let bonusTO = to >= 95 && to <= 98 ? 10 : to > 98 ? 15 : 0;
        let bonusChecklist = checklist > 95 ? 15 : 0;
        let bonusOVK = ovk >= 100 ? 25 : 0;
        let bonusATO = ato >= 85 && ato <= 95 ? 15 : ato > 95 ? 25 : 0;

        const totalBonusPerHour=bonusTO+bonusChecklist+bonusOVK+bonusATO;
        const totalRate=baseRate+totalBonusPerHour;
        const totalPerShift=totalRate*hours;

        resultHTML = `
        <div class="result-section"><h3>Расчёт надбавок за час</h3>
          <div class="result-item"><span>Надбавка за ТО (%: ${to}%)</span><strong>${bonusTO.toFixed(0)} ₽/час</strong></div>
          <div class="result-item"><span>Надбавка за чек-лист (%: ${checklist}%)</span><strong>${bonusChecklist.toFixed(0)} ₽/час</strong></div>
          <div class="result-item"><span>Надбавка за ОВК (%: ${ovk}%)</span><strong>${bonusOVK.toFixed(0)} ₽/час</strong></div>
          <div class="result-item"><span>Надбавка за АТО+СГИ (%: ${ato}%)</span><strong>${bonusATO.toFixed(0)} ₽/час</strong></div>
        </div>
        <div class="result-section"><h3>Итоговый расчёт</h3>
          <div class="result-item"><span>Итоговая надбавка за час</span><strong>${totalBonusPerHour.toFixed(0)} ₽/час</strong></div>
          <div class="result-item"><span>Итоговая ставка за час</span><strong>${totalRate.toFixed(0)} ₽/час</strong></div>
          <div class="result-item"><span>Зарплата за смену (${hours.toFixed(1)} ч)</span><strong>${totalPerShift.toFixed(0)} ₽</strong></div>
        </div>
        <hr /><div class="result-total">Итоговая зарплата за смену: <strong>${totalPerShift.toFixed(0)} ₽</strong></div>`;
      }
      else if(role==='others'){
        const TO=parseFloat($('others_to').value);
        const TO_percent=parseFloat($('others_to_percent').value);
        const hasTP=$('others_has_tp').value;
        const TP=hasTP==='yes'?parseFloat($('others_tp').value):0;
        const complaints=parseInt($('others_complaints').value);
        const hasATO=$('others_has_ato').value;
        const ATO=hasATO==='yes'?parseFloat($('others_ato').value):0;
        const hourlyRate=parseFloat($('others_hourly_rate').value);
        const shiftLength=parseFloat($('others_shift_length').value);
        const totalHours=parseFloat($('others_total_hours').value);

        let coefTP=1; if(hasTP==='yes'){ if(TP<80){coefTP=0.5;} else if(TP<95){coefTP=1;} else {coefTP=2;} }
        let coefComplaints = complaints===0?1:0.75;
        let coefATO=1; if(hasATO==='yes'){ if(ATO<85){coefATO=0.5;} else if(ATO<=95){coefATO=1;} else {coefATO=2;} }

        let fundTO = TO_percent <= 100 ? 0.009 * TO : 0.018 * TO;
        let fund = fundTO * coefTP * coefComplaints * coefATO;

        const salaryBase=hourlyRate*shiftLength;
        const personalBonus=(fund/totalHours)*shiftLength;
        const totalSalary=salaryBase+personalBonus;

        resultHTML=`
        <div class="result-section"><h3>Расчёт фонда премии</h3>
          <div class="result-item"><span>Базовый фонд от ТО (%: ${TO_percent}%)</span><strong>${fundTO.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Коэффициент ТП (${hasTP==='yes'?TP+'%':'не было'})</span><strong>${coefTP.toFixed(2)}</strong></div>
          <div class="result-item"><span>Коэффициент жалоб (${complaints})</span><strong>${coefComplaints.toFixed(2)}</strong></div>
          <div class="result-item"><span>Коэффициент АТО+СГИ (${hasATO==='yes'?ATO+'%':'не было'})</span><strong>${coefATO.toFixed(2)}</strong></div>
          <div class="result-item"><span>Итоговый фонд</span><strong>${fund.toFixed(0)} ₽</strong></div>
        </div>
        <div class="result-section"><h3>Расчёт зарплаты</h3>
          <div class="result-item"><span>База за смену (${shiftLength.toFixed(1)} ч)</span><strong>${salaryBase.toFixed(0)} ₽</strong></div>
          <div class="result-item"><span>Доля из фонда (команда: ${totalHours} ч)</span><strong>${personalBonus.toFixed(0)} ₽</strong></div>
        </div>
        <hr /><div class="result-total">Итоговая зарплата за смену: <strong>${totalSalary.toFixed(0)} ₽</strong></div>`;
      }
      else if(role==='general'){
        const hourlyRate=parseFloat($('general_rate').value);
        const shifts=parseInt($('general_shifts').value);
        const hours=parseFloat($('general_hours').value);
        if(isNaN(hourlyRate)||isNaN(shifts)||isNaN(hours)){
          resultHTML = "<p style='color:red;'>Пожалуйста, заполните все поля для расчёта.</p>";
        } else {
          const salary=hourlyRate*shifts*hours;
          resultHTML = `
          <div class="result-section"><h3>Параметры расчёта</h3>
            <div class="result-item"><span>Часовая ставка</span><strong>${hourlyRate.toFixed(0)} ₽/час</strong></div>
            <div class="result-item"><span>Количество смен</span><strong>${shifts}</strong></div>
            <div class="result-item"><span>Длительность смены</span><strong>${hours.toFixed(1)} ч</strong></div>
          </div>
          <hr /><div class="result-total">Итоговая зарплата за месяц: <strong>${salary.toFixed(0)} ₽</strong></div>`;
        }
      } else { resultHTML = '<p>Пожалуйста, выберите должность.</p>'; }

      resultDiv.innerHTML=resultHTML;
    }

    function initCustomSelect(nativeId, wrapperId){
      const native=$(nativeId);
      const wrap=$(wrapperId);
      const btn=wrap.querySelector('.custom-select-toggle');
      const menu=wrap.querySelector('.custom-select-menu');
      const search=menu.querySelector('.custom-select-search input');
      const options=Array.from(menu.querySelectorAll('.custom-option'));

      function close(){ wrap.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      function open(){ wrap.classList.add('open'); btn.setAttribute('aria-expanded','true'); search.focus(); }

      btn.addEventListener('click', ()=> wrap.classList.contains('open') ? close() : open());
      root.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) close(); });
      btn.addEventListener('keydown', (e)=>{ if((e.key==='ArrowDown'||e.key==='Enter'||e.key===' ')&&!wrap.classList.contains('open')){ e.preventDefault(); open(); } });

      options.forEach(opt=>{
        opt.addEventListener('click', ()=>{
          const val=opt.getAttribute('data-value')||'';
          options.forEach(o=>o.removeAttribute('aria-selected'));
          opt.setAttribute('aria-selected','true');
          btn.textContent=opt.textContent.trim();
          native.value=val;
          native.dispatchEvent(new Event('change',{bubbles:true}));
          close();
        });
      });

      search.addEventListener('input', ()=>{
        const q=search.value.toLowerCase().trim();
        options.forEach(o=>{ const txt=o.textContent.toLowerCase(); o.style.display = txt.includes(q) ? '' : 'none'; });
      });
    }

    // ==== INIT ====
    mountHintButtonsInsideInputs();
    bindProgressiveReveal();
    initCustomSelect('role','roleCustom');

    [['general_shifts','shiftValue',0],['general_hours','hoursValue',1],['hours','povarHoursValue',1],['others_shift_length','othersShiftValue',1]]
      .forEach(([sid,oid,dec])=>{const s=$(sid),o=$(oid);if(s&&o){o.textContent=dec?parseFloat(s.value).toFixed(1):s.value;}});

    Object.keys(deps).forEach(id=>{ const el=$(id); if(el){ el.addEventListener('change', ()=>toggleDependent(id)); }});
    qs('#calcTop').addEventListener('click', calculateSalary);
    qs('#calcBottom').addEventListener('click', calculateSalary);
    qs('#copyBtnTop').addEventListener('click', copyData);
    qs('#copyBtnBottom').addEventListener('click', copyData);
    root.getElementById('role').addEventListener('change', toggleRoleFields);
  }
}
customElements.define('salary-calculator', SalaryCalculator);
  </script>

  <!-- Скрипт для авто-подгонки высоты iframe -->
  <script>
    function sendHeight() {
      parent.postMessage({ type: 'salaryCalcHeight', height: document.documentElement.scrollHeight }, '*');
    }
    new ResizeObserver(sendHeight).observe(document.documentElement);
    window.addEventListener('load', sendHeight);
  </script>

</body>
</html>
