<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор зарплаты</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#F5EDDF; --surface:#FFFCF6; --text:#1A1A1A; --muted:#786B5E;
      --line:#E6DCCD; --accent:#7A553A; --accent-2:#DCCBB7;
      --r-sm:8px; --r-md:12px; --r-lg:16px;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-6:24px; --sp-8:40px;
      --shadow-1:0 1px 2px rgba(0,0,0,.04),0 6px 18px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(122,85,58,.25);
      --font-sans:"Formular","Inter","Helvetica Neue",Arial,sans-serif;
    }

    /* фон */
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#F5EDDF 0%,#FFF7EA 100%);
      color:var(--text);
      font-family:var(--font-sans);
      line-height:1.5;
    }

    /* ГЛОБАЛЬНЫЙ СКРОЛБАР */
    html{
      scrollbar-width:thin;
      scrollbar-color:var(--accent-2) transparent;
      scroll-behavior:smooth;
      scrollbar-gutter:stable;
    }
    ::-webkit-scrollbar{ width:12px; height:12px; }
    ::-webkit-scrollbar-track{ background:transparent; }
    ::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg,var(--accent-2),#E9DACC);
      border:3px solid transparent; border-radius:999px;
      background-clip:padding-box; box-shadow:inset 0 0 0 1px rgba(0,0,0,.04);
      transition:background .2s ease;
    }
    ::-webkit-scrollbar-thumb:hover{ background:linear-gradient(180deg,#E2D0BC,#D4C2AE); }

    /* ФИКСИРОВАННЫЙ ХЕДЕР (п.6) */
    .site-header{
      position:sticky; top:0; z-index:40;
      background:rgba(255,252,246,.7);
      backdrop-filter:saturate(140%) blur(6px);
      border-bottom:1px solid rgba(230,220,205,.7);
      transition: box-shadow .25s ease, background .25s ease;
    }
    body.scrolled .site-header{ box-shadow:0 6px 18px rgba(0,0,0,.08); background:rgba(255,252,246,.9); }

    .header-inner{
      max-width:1100px;margin:0 auto;
      padding:12px var(--sp-4);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{font-weight:800;font-size:clamp(20px,3vw,28px);letter-spacing:.2px;}
    .subtitle{color:var(--muted);font-size:13px;}

    .container{max-width:1100px;margin:0 auto;padding:var(--sp-8) var(--sp-4) var(--sp-8);}
    .layout{display:grid;grid-template-columns:1.4fr .9fr;gap:var(--sp-6);}
    @media (max-width:900px){.layout{grid-template-columns:1fr}}

    /* КАРТОЧКИ + МИКРОАНИМАЦИИ (п.2, п.10) */
    .card{
      background:rgba(255,252,246,.95);
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow-1);
      padding:var(--sp-6);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
    }
    .section-title{margin:0 0 var(--sp-4);font-weight:800;font-size:20px;letter-spacing:.2px;color:var(--accent);}

    label{display:block;font-weight:600;color:var(--muted);font-size:14px;margin-bottom:var(--sp-2);}
    .field-container{position:relative;display:flex;flex-direction:column;gap:6px;margin-bottom:var(--sp-4);}
    .field{display:none;opacity:0;transform:translateY(6px);transition:opacity .25s ease, transform .25s ease;}
    .field.visible{display:block;opacity:1;transform:translateY(0);}

    /* поля */
    .field-container input,
    .field-container select{
      width:100%; padding:12px 14px; border-radius:var(--r-md); border:1px solid var(--line);
      background:var(--surface); font-size:16px; transition:border-color .2s,box-shadow .2s;
      box-sizing:border-box;
    }
    select:focus,input:focus{outline:none;border-color:var(--accent-2);box-shadow:var(--focus);}

    .control-wrap{position:relative;width:100%;}
    .control-wrap input[type="number"], .control-wrap select{padding-right:48px;}
    .control-wrap .slider-container{padding-right:48px;}

    /* ? подсказки (микро-анимации п.10) */
    .hint-button{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:26px;height:26px;border-radius:50%;
      background:var(--accent);color:#fff;border:none;cursor:pointer;
      font-size:14px;display:none;align-items:center;justify-content:center; z-index:1;
      transition: transform .1s ease, filter .2s ease;
    }
    .hint-button:hover{filter:brightness(1.06)}
    .hint-button:active{transform:translateY(-50%) scale(.98)}
    .hint-text{
      display:none;position:absolute;z-index:10;right:0;top:calc(100% + 6px);
      background:var(--surface);color:var(--text);border:1px solid var(--line);border-radius:var(--r-md);
      padding:10px 12px;font-size:14px;box-shadow:var(--shadow-1);max-width:320px;
      animation: fadeIn .18s ease both;
    }
    .hint-text.visible{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

    .toolbar{display:flex;gap:var(--sp-4);flex-wrap:wrap;margin-top:var(--sp-6);}
    .btn{flex:1;min-width:220px;padding:14px 18px;border:1px solid transparent;border-radius:999px;background:var(--accent);color:#fff;font-weight:800;font-size:16px;cursor:pointer;transition:filter .2s,transform .05s, box-shadow .2s;}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--line)}

    .section{display:none;margin-top:var(--sp-4);background:#fff;border:1px solid var(--line);border-radius:var(--r-lg);padding:var(--sp-6);}
    .result-card{position:sticky;top:calc(var(--sp-8) + 56px)} /* учитываем высоту хедера */
    #result{
      background:linear-gradient(0deg,#fff,#fff) padding-box,conic-gradient(from 180deg at 50% 50%,var(--accent-2),#F6EFE6) border-box;
      border:1px solid var(--line);border-radius:var(--r-lg);padding:var(--sp-6);color:var(--accent);font-weight:800;text-wrap:pretty;
    }

    /* слайдеры */
    input[type="range"]{height:36px;background:transparent;-webkit-appearance:none;}
    input[type="range"]::-webkit-slider-runnable-track{height:6px;background:var(--line);border-radius:999px;}
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;margin-top:-7px;width:20px;height:20px;border-radius:50%;
      background:var(--accent);box-shadow:0 0 0 4px rgba(122,85,58,.15);cursor:pointer;transition: box-shadow .2s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover{ box-shadow:0 0 0 6px rgba(122,85,58,.15);}
    input[type="range"]::-moz-range-track{height:6px;background:var(--line);border-radius:999px;}
    input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:none;box-shadow:0 0 0 4px rgba(122,85,58,.15);cursor:pointer;}

    .inline-value{margin-left:8px;font-weight:700;color:var(--text);min-width:40px;display:inline-block;text-align:right;}

    /* КАСТОМНЫЙ SELECT С ПОИСКОМ И СВОИМ СКРОЛЛОМ (п.1) */
    .visually-hidden{position:absolute!important;left:-9999px!important;top:auto!important;width:1px!important;height:1px!important;overflow:hidden!important;}
    .custom-select{position:relative;}
    .custom-select-toggle{
      width:100%;
      padding:12px 44px 12px 14px;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:var(--surface);
      font-size:16px; text-align:left; cursor:pointer;
      transition:border-color .2s, box-shadow .2s;
    }
    .custom-select-toggle:focus{outline:none;border-color:var(--accent-2);box-shadow:var(--focus);}
    .custom-select-toggle::after{
      content:""; position:absolute; right:16px; top:50%; transform:translateY(-50%);
      border:6px solid transparent; border-top-color:var(--muted);
      transition: transform .2s ease;
    }
    .custom-select.open .custom-select-toggle::after{ transform:translateY(-25%) rotate(180deg); }

    .custom-select-menu{
      position:absolute; z-index:20; left:0; right:0; margin-top:6px;
      background:var(--surface); border:1px solid var(--line); border-radius:var(--r-md);
      box-shadow:var(--shadow-1); max-height:260px; overflow:auto; display:none;
      animation: fadeIn .15s ease both;
    }
    .custom-select.open .custom-select-menu{display:block;}
    .custom-select-search{
      padding:8px; position:sticky; top:0; background:linear-gradient(#FFFCF6,#FFFCF6);
      border-bottom:1px solid var(--line);
    }
    .custom-select-search input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; font-size:14px;
    }
    .custom-option{ padding:10px 12px; cursor:pointer; font-size:16px; }
    .custom-option:hover{ background:#FFF6EA; }
    .custom-option[aria-selected="true"]{ background:#F1E6D8; font-weight:700; }

    /* ФИКСИРОВАННАЯ ПАНЕЛЬ ДЕЙСТВИЙ (п.3) */
    .action-bar{
      position:fixed; left:0; right:0; bottom:0; z-index:45;
      display:flex; justify-content:center;
      padding:10px 12px;
      background:linear-gradient(180deg,rgba(255,252,246,0),rgba(255,252,246,.9) 30%,rgba(255,252,246,.98) 100%);
      border-top:1px solid rgba(230,220,205,.9);
      backdrop-filter:saturate(150%) blur(6px);
      transform:translateY(120%); transition:transform .25s ease;
    }
    .action-bar.visible{ transform:translateY(0); }
    .action-inner{ width:min(980px,94vw); display:flex; gap:12px; }
    .action-inner .btn{ flex:1; }

    /* утилити */
    .mt-0{margin-top:0}

    /* ——— Нейтральный стиль только для селектора роли ——— */
    #roleCustom .custom-select-toggle{
      background:var(--surface);
      border-color:var(--line);
      box-shadow:none;
      padding-top:12px;
      padding-left:14px;
    }
    #roleCustom .custom-select-toggle::before{ content:none; }
    #roleCustom .custom-select::before{ content:none; }
    #roleCustom .custom-select.open .custom-select-toggle,
    #roleCustom .custom-select-toggle:focus{
      border-color:var(--accent-2);
      box-shadow:var(--focus);
    }
    #roleCustom .custom-select-menu{
      border-color:var(--line);
      box-shadow:var(--shadow-1);
    }
    #roleCustom .custom-option:hover{ background:#FFF6EA; }
    #roleCustom .custom-option[aria-selected="true"]{ background:#F1E6D8; font-weight:700; }

  </style>
</head>
<body class="features-on"><!-- убери class="features-on" чтобы отключить улучшения разом -->
  <!-- ХЕДЕР (п.6) -->
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">Калькулятор зарплаты</div>
    </div>
  </header>

  <div class="container">
    <div class="layout">
      <main class="pane">
        <div class="card">
          <h2 class="section-title mt-0">Выбор роли</h2>

          <!-- Нативный select сохраняем для логики, но скрываем -->
          <label for="role" class="field visible">Должность</label>
          <select id="role" class="visually-hidden" onchange="toggleRoleFields()">
            <option value="">— Выберите —</option>
            <option value="zam">Заместитель директора</option>
            <option value="povar">Повар</option>
            <option value="others">Старший кассир / Кассир / Бариста / Работник торгового зала / Повар-универсал</option>
            <option value="general">Общий подсчёт</option>
          </select>

          <!-- Кастомный селект с поиском и своим скроллом (п.1) -->
          <div class="custom-select" id="roleCustom">
            <button type="button" class="custom-select-toggle" aria-haspopup="listbox" aria-expanded="false">— Выберите —</button>
            <div class="custom-select-menu" role="listbox" tabindex="-1">
              <div class="custom-select-search">
                <input type="text" placeholder="Поиск должности…" aria-label="Поиск">
              </div>
              <div class="custom-option" role="option" data-value="">— Выберите —</div>
              <div class="custom-option" role="option" data-value="zam">Заместитель директора</div>
              <div class="custom-option" role="option" data-value="povar">Повар</div>
              <div class="custom-option" role="option" data-value="others">Старший кассир / Кассир / Бариста / Работник торгового зала / Повар-универсал</div>
              <div class="custom-option" role="option" data-value="general">Общий подсчёт</div>
            </div>
          </div>

          <!-- СЕКЦИИ ФОРМЫ (оставлены как были) -->
          <div id="zamFields" class="section">
            <h3 class="section-title">Показатели за месяц</h3>
            <div class="field-container">
              <label class="field" data-field="zam_to">На сколько процентов был выполнен план по ТО за месяц? (%) <input type="number" id="zam_to" min="0"></label>
              <button class="hint-button" onclick="toggleHint('zam_to_hint')">?</button>
              <div id="zam_to_hint" class="hint-text">% от фактического ТО — это процент выполнения плана по товарообороту за месяц. Например, если план был 100 000 ₽, а вы заработали 95 000 ₽, введите 95%.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="zam_tp">На сколько процентов была пройдена проверка Тайного покупателя? (%) <input type="number" id="zam_tp" min="0"></label>
              <button class="hint-button" onclick="toggleHint('zam_tp_hint')">?</button>
              <div id="zam_tp_hint" class="hint-text">Процент выполнения проверки Тайного покупателя — это оценка качества обслуживания, которую ставит непосредственно тайный покупатель. Укажите процент прохождения чек-листа.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="zam_ato">Каков процент прохождения АТО+СГИ? (%) <input type="number" id="zam_ato" min="0"></label>
              <button class="hint-button" onclick="toggleHint('zam_ato_hint')">?</button>
              <div id="zam_ato_hint" class="hint-text">АТО+СГИ — это показатели аудита торговой точки и соблюдения санитарных норм. Укажите процент выполнения этих стандартов за месяц.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="zam_hr">Сколько процентов по HR-индексу получила лавка в этом месяце? (%) <input type="number" id="zam_hr" min="0"></label>
              <button class="hint-button" onclick="toggleHint('zam_hr_hint')">?</button>
              <div id="zam_hr_hint" class="hint-text">Итоговый ежемесячный показатель HR-индекса.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="zam_feedback">Какое количество отрицательных отзывов на 10 000 чеков? <input type="number" id="zam_feedback" min="0"></label>
              <button class="hint-button" onclick="toggleHint('zam_feedback_hint')">?</button>
              <div id="zam_feedback_hint" class="hint-text">Укажите количество отрицательных отзывов, полученных за месяц, в пересчёте на 10 000 чеков. Например, если было 2 отзыва на 5 000 чеков, введите 4.</div>
            </div>
          </div>

          <div id="povarFields" class="section">
            <h3 class="section-title">Параметры смены</h3>
            <div class="field-container">
              <label class="field" data-field="baseRate">Укажи свою часовую ставку (₽) <input type="number" id="baseRate" min="0"></label>
              <button class="hint-button" onclick="toggleHint('baseRate_hint')">?</button>
              <div id="baseRate_hint" class="hint-text">Сумма за один час работы без премий.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="hours">Укажи длительность твоей смены (часы)
                <div class="slider-container">
                  <input type="range" id="hours" min="0.5" max="24" step="0.5" value="0.5">
                  <span id="povarHoursValue" class="inline-value">0.5</span>
                </div>
              </label>
              <button class="hint-button" onclick="toggleHint('hours_hint')">?</button>
              <div id="hours_hint" class="hint-text">Диапазон 0.5–24 с шагом 0.5.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="to">На сколько процентов был выполнен план по ТО? (%) <input type="number" id="to" min="0"></label>
              <button class="hint-button" onclick="toggleHint('to_hint')">?</button>
              <div id="to_hint" class="hint-text">Процент выполнения плана по товарообороту (ТО) — это соотношение фактической выручки к плановой за смену. Например, если план 500 000 ₽, а выручка 475 000 ₽, введите 95%..</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="povar_has_checklist">Была ли проверка чек-листа?
                <select id="povar_has_checklist">
                  <option value="">— Выберите —</option>
                  <option value="yes">Да</option>
                  <option value="no">Нет/Не знаю</option>
                </select>
              </label>
              <button class="hint-button" onclick="toggleHint('povar_has_checklist_hint')">?</button>
              <div id="povar_has_checklist_hint" class="hint-text">Выберите, проводилась ли проверка чек-листа Шеф-повара во время вашей смены.</div>
            </div>
            <div class="field-container" id="povar_checklist_container">
              <label class="field" data-field="checklist">Каков был процент прохождения чек-листа Шеф-повара за смену? (%) <input type="number" id="checklist" min="0"></label>
              <button class="hint-button" onclick="toggleHint('checklist_hint')">?</button>
              <div id="checklist_hint" class="hint-text">Укажите общий процент прохождения проверки за смену.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="povar_has_ovk">Была ли проверка по униформе (ОВК)?
                <select id="povar_has_ovk">
                  <option value="">— Выберите —</option>
                  <option value="yes">Да</option>
                  <option value="no">Нет/Не знаю</option>
                </select>
              </label>
              <button class="hint-button" onclick="toggleHint('povar_has_ovk_hint')">?</button>
              <div id="povar_has_ovk_hint" class="hint-text">Выберите, проводилась ли проверка по униформе (ОВК) во время вашей смены.</div>
            </div>
            <div class="field-container" id="povar_ovk_container">
              <label class="field" data-field="ovk">На сколько была пройдена проверка по униформе (ОВК) за смену? (%) <input type="number" id="ovk" min="0"></label>
              <button class="hint-button" onclick="toggleHint('ovk_hint')">?</button>
              <div id="ovk_hint" class="hint-text">Укажите процент выполнения проверки по униформе (ОВК) за смену.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="povar_has_ato">Была ли проверка АТО + СГИ?
                <select id="povar_has_ato">
                  <option value="">— Выберите —</option>
                  <option value="yes">Да</option>
                  <option value="no">Нет/Не знаю</option>
                </select>
              </label>
              <button class="hint-button" onclick="toggleHint('povar_has_ato_hint')">?</button>
              <div id="povar_has_ato_hint" class="hint-text">Выберите, проводилась ли проверка АТО+СГИ во время вашей смены.</div>
            </div>
            <div class="field-container" id="povar_ato_container">
              <label class="field" data-field="ato">Каков процент прохождения АТО+СГИ за месяц? (%) <input type="number" id="ato" min="0"></label>
              <button class="hint-button" onclick="toggleHint('ato_hint')">?</button>
              <div id="ato_hint" class="hint-text">АТО+СГИ — это показатели аудита торговой точки и санитарных норм. Укажите процент выполнения этих стандартов за месяц.</div>
            </div>
          </div>

          <div id="othersFields" class="section">
            <h3 class="section-title">Смена и показатели</h3>
            <div class="field-container">
              <label class="field" data-field="others_hourly_rate">Укажи свою часовую ставку (₽) <input type="number" id="others_hourly_rate" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_hourly_rate_hint')">?</button>
              <div id="others_hourly_rate_hint" class="hint-text">Сумма за один час работы.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_shift_length">Сколько длилась твоя смена? (часы)
                <div class="slider-container">
                  <input type="range" id="others_shift_length" min="0.5" max="24" step="0.5" value="0.5">
                  <span id="othersShiftValue" class="inline-value">0.5</span>
                </div>
              </label>
              <button class="hint-button" onclick="toggleHint('others_shift_length_hint')">?</button>
              <div id="others_shift_length_hint" class="hint-text">Диапазон 0.5–24.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_to">Сколько составил Товарооборот за день?(₽) <input type="number" id="others_to" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_to_hint')">?</button>
              <div id="others_to_hint" class="hint-text">Товарооборот — это общая сумма выручки за день (все продажи). Укажите сумму в рублях, например, 500000 ₽. (Эту информацию ты можешь уточнить у своего директора, либо по Дашборду).</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_to_percent">На сколько процентов был выполнен план по ТО? (%) <input type="number" id="others_to_percent" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_to_percent_hint')">?</button>
              <div id="others_to_percent_hint" class="hint-text">Процент выполнения плана по товарообороту (ТО) — это соотношение фактической выручки к плановой за день. Например, если план 50 000 ₽, а выручка 47 500 ₽, введите 95%. (Эту информацию ты можешь уточнить у своего директора, либо по Дашборду)</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_has_tp">Была ли проверка от Тайного покупателя?
                <select id="others_has_tp">
                  <option value="">— Выберите —</option>
                  <option value="yes">Да</option>
                  <option value="no">Нет/Не знаю</option>
                </select>
              </label>
              <button class="hint-button" onclick="toggleHint('others_has_tp_hint')">?</button>
              <div id="others_has_tp_hint" class="hint-text">Выберите, была ли проведена проверка Тайного покупателя во время вашей смены.</div>
            </div>
            <div class="field-container" id="others_tp_container">
              <label class="field" data-field="others_tp">На сколько процентов была пройдена проверка Тайного покупателя? (Эту информацию ты можешь уточнить у своего директора) (%) <input type="number" id="others_tp" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_tp_hint')">?</button>
              <div id="others_tp_hint" class="hint-text">Процент выполнения проверки Тайного покупателя — это оценка качества обслуживания, которую ставит непосредственно тайный покупатель. Укажите процент прохождения чек-листа.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_complaints">Сколько подтвержденных отрицательных отзывов было получено за смену? <input type="number" id="others_complaints" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_complaints_hint')">?</button>
              <div id="others_complaints_hint" class="hint-text">Укажите количество подтверждённых жалоб от клиентов, полученных за смену. (Эту информацию ты можешь уточнить у своего директора).</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_has_ato">Было ли прохождение АТО + СГИ?
                <select id="others_has_ato">
                  <option value="">— Выберите —</option>
                  <option value="yes">Да</option>
                  <option value="no">Нет/Не знаю</option>
                </select>
              </label>
              <button class="hint-button" onclick="toggleHint('others_has_ato_hint')">?</button>
              <div id="others_has_ato_hint" class="hint-text">Выберите, проводилась ли проверка АТО+СГИ во время вашей смены.</div>
            </div>
            <div class="field-container" id="others_ato_container">
              <label class="field" data-field="others_ato">Каков процент прохождения АТО+СГИ за смену? (%) <input type="number" id="others_ato" min="0"></label>
              <button class="hint-button" onclick="toggleHint('others_ato_hint')">?</button>
              <div id="others_ato_hint" class="hint-text">АТО+СГИ — это показатели аудита торговой точки и соблюдения санитарных норм. Укажите процент выполнения этих стандартов за смену. (Эту информацию ты можешь уточнить у своего директора)</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="others_total_hours">Сколько часов вы суммарно отработали с командой за смену?(часы) <input type="number" id="others_total_hours" min="1"></label>
              <button class="hint-button" onclick="toggleHint('others_total_hours_hint')">?</button>
              <div id="others_total_hours_hint" class="hint-text">Укажите общее количество часов, отработанных всей командой за смену. Например, если 3 человека работали по 8 часов, введите 24. (Эту информацию ты можешь уточнить у своего директора)</div>
            </div>
          </div>

          <div id="generalFields" class="section">
            <h3 class="section-title">План на месяц</h3>
            <div class="field-container">
              <label class="field" data-field="general_rate">Укажи свою часовую ставку (₽) <input type="number" id="general_rate" min="0"></label>
              <button class="hint-button" onclick="toggleHint('general_rate_hint')">?</button>
              <div id="general_rate_hint" class="hint-text">Сумма за час без премий.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="general_shifts">Сколько дней в месяце планируешь работать?
                <div class="slider-container">
                  <input type="range" id="general_shifts" min="1" max="31" step="1" value="1">
                  <span id="shiftValue" class="inline-value">1</span>
                </div>
              </label>
              <button class="hint-button" onclick="toggleHint('general_shifts_hint')">?</button>
              <div id="general_shifts_hint" class="hint-text">Диапазон 1–31.</div>
            </div>
            <div class="field-container">
              <label class="field" data-field="general_hours">По сколько часов в день планируешь работать?
                <div class="slider-container">
                  <input type="range" id="general_hours" min="0.5" max="24" step="0.5" value="0.5">
                  <span id="hoursValue" class="inline-value">0.5</span>
                </div>
              </label>
              <button class="hint-button" onclick="toggleHint('general_hours_hint')">?</button>
              <div id="general_hours_hint" class="hint-text">Диапазон 0.5–24.</div>
            </div>
          </div>

          <div class="toolbar">
            <button class="btn" id="calcTop" onclick="calculateSalary()">Рассчитать</button>
            <button class="btn secondary" onclick="copyData()">Копировать данные</button>
          </div>
        </div>
      </main>

      <aside class="pane result-card">
        <div id="result">Результат появится после расчёта.</div>
      </aside>
    </div>
  </div>

  <!-- ФИКС. ПАНЕЛЬ ДЕЙСТВИЙ (п.3) -->
  <div class="action-bar" id="actionBar">
    <div class="action-inner">
      <button class="btn" id="calcBottom">Рассчитать</button>
      <button class="btn secondary" onclick="copyData()">Копировать данные</button>
    </div>
  </div>

  <script>
    /* утилиты */
    function $(id){ return document.getElementById(id); }
    function toggleHint(id){ const el=$(id); if(!el) return; el.classList.toggle('visible'); }

    /* кнопка ? внутрь поля */
    function mountHintButtonsInsideInputs(){
      document.querySelectorAll('.field-container').forEach(fc=>{
        const btn = fc.querySelector('.hint-button');
        const label = fc.querySelector('label.field');
        if(!btn || !label) return;
        const slider = label.querySelector('.slider-container');
        const ctrl = slider || label.querySelector('input, select'); if(!ctrl) return;
        let wrap = ctrl.closest('.control-wrap');
        if(!wrap){
          wrap = document.createElement('div');
          wrap.className = 'control-wrap';
          ctrl.parentNode.replaceChild(wrap, ctrl);
          wrap.appendChild(ctrl);
        }
        wrap.appendChild(btn);
        btn.style.display = 'inline-flex';
      });
    }

    /* зависимости Да/Нет */
    const deps = {
      povar_has_checklist:{container:'povar_checklist_container', input:'checklist'},
      povar_has_ovk:{container:'povar_ovk_container', input:'ovk'},
      povar_has_ato:{container:'povar_ato_container', input:'ato'},
      others_has_tp:{container:'others_tp_container', input:'others_tp'},
      others_has_ato:{container:'others_ato_container', input:'others_ato'}
    };

    function resetSection(section){
      section.style.display='none';
      section.querySelectorAll('.field').forEach(f=>f.classList.remove('visible'));
      section.querySelectorAll('.hint-button').forEach(b=>{b.style.display='none';b.style.opacity='0';});
      section.querySelectorAll('input[type="number"]').forEach(i=>i.value='');
      section.querySelectorAll('select').forEach(s=>s.value='');
      section.querySelectorAll('input[type="range"]').forEach(r=>{
        r.value=r.min;
        const span=r.parentElement.querySelector('span');
        if(span) span.textContent = r.step && r.step.includes('.') ? parseFloat(r.value).toFixed(1) : r.value;
      });
      Object.values(deps).forEach(d=>{ const c=$(d.container); if(c) c.style.display='none'; });
    }

    function showRoleSection(role){
      const secId = role+'Fields';
      const sec = $(secId); if(!sec) return;
      sec.style.display='block';
      const first = sec.querySelector('.field');
      if(first){
        first.classList.add('visible');
        const btn = first.parentElement.querySelector('.hint-button');
        if(btn){ btn.style.display='inline-flex'; btn.style.opacity='1'; }
      }
    }

    function toggleDependent(selectId){
      const cfg = deps[selectId]; if(!cfg) return;
      const sel=$(selectId), cont=$(cfg.container), inp=$(cfg.input);
      if(!sel || !cont) return;
      const yes = sel.value==='yes';
      cont.style.display = yes ? 'block' : 'none';
      const field = cont.querySelector('.field');
      const btn = cont.querySelector('.hint-button');
      if(yes){
        field && field.classList.add('visible');
        if(btn){ btn.style.display='inline-flex'; btn.style.opacity='1'; }
      } else {
        field && field.classList.remove('visible');
        if(btn){ btn.style.display='none'; btn.style.opacity='0'; }
        if(inp){ const el=$(inp); if(el) el.value=''; }
      }
    }

    /* прогрессивное раскрытие */
    function revealNextIfValid(sectionId, currentFieldId){
      const sec=$(sectionId); if(!sec) return;
      const fields = Array.from(sec.querySelectorAll('.field'));
      const cur = sec.querySelector('[data-field="'+currentFieldId+'"]'); if(!cur) return;
      const input = cur.querySelector('input, select'); if(!input) return;

      let valid=false;
      if(input.tagName==='SELECT'){ valid = input.value!==''; }
      else if(input.type==='range'){ valid = input.value!=='' && parseFloat(input.value)>=parseFloat(input.min||'0'); }
      else { valid = input.value!=='' && !isNaN(parseFloat(input.value)) && parseFloat(input.value)>=0; }

      Object.values(deps).forEach(cfg=>{
        if(currentFieldId===cfg.input){
          const parentSel = Object.keys(deps).find(k=>deps[k].input===cfg.input);
          const sel=$(parentSel);
          if(sel && sel.value!=='yes') valid=false;
        }
      });

      const idx = fields.indexOf(cur);
      if(valid){
        input.classList.remove('error');
        for(let i=idx+1;i<fields.length;i++){
          const f = fields[i];
          const name = f.getAttribute('data-field')||'';
          const block = Object.keys(deps).some(sid=>{
            const c = deps[sid]; return name===c.input && $(sid) && $(sid).value!=='yes';
          });
          if(block) continue;
          f.classList.add('visible');
          const b=f.parentElement.querySelector('.hint-button');
          if(b){ b.style.display='inline-flex'; b.style.opacity='1'; }
          break;
        }
      } else {
        input.classList.add('error');
        for(let i=idx+1;i<fields.length;i++){
          const f=fields[i];
          f.classList.remove('visible');
          const b=f.parentElement.querySelector('.hint-button');
          if(b){ b.style.display='none'; b.style.opacity='0'; }
          const ni=f.querySelector('input, select');
          if(ni){
            if(ni.tagName==='SELECT') ni.value='';
            else if(ni.type==='range'){
              ni.value=ni.min;
              const s=ni.parentElement.querySelector('span');
              if(s) s.textContent = ni.step && ni.step.includes('.') ? parseFloat(ni.value).toFixed(1) : ni.value;
            } else ni.value='';
          }
        }
      }
    }

    function toggleRoleFields(){
      document.querySelectorAll('.section').forEach(resetSection);
      $('result').innerHTML='Результат появится после расчёта.';
      const role = $('role').value; if(!role) return;
      showRoleSection(role);
      Object.keys(deps).forEach(id=>{ const el=$(id); if(el) toggleDependent(id); });
    }

    function bindProgressiveReveal(){
      document.querySelectorAll('input[type="number"], input[type="range"], select').forEach(el=>{
        const handler=()=>{
          const section = el.closest('.section');
          if(!section || section.style.display==='none') return;
          if(el.type==='range'){
            const span=el.parentElement && el.parentElement.querySelector('span');
            if(span){ span.textContent = el.step && el.step.includes('.') ? parseFloat(el.value).toFixed(1) : el.value; }
          }
          if(deps[el.id]) toggleDependent(el.id);
          const df = el.closest('.field')?.getAttribute('data-field');
          if(df) revealNextIfValid(section.id, df);
        };
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
      });
    }

    /* копирование и расчёт — ваша логика */
    function copyData() {
      const role = document.getElementById("role").value;
      if (!role) { alert("Пожалуйста, выберите должность."); return; }
      let dataText = [], fields = [];
      if (role === "zam") {
        fields = [
          { id: "zam_to", label: "Процент выполнения плана по ТО (%)" },
          { id: "zam_tp", label: "Процент проверки Тайного покупателя (%)" },
          { id: "zam_ato", label: "Процент прохождения АТО+СГИ (%)" },
          { id: "zam_hr", label: "Процент HR-индекса (%)" },
          { id: "zam_feedback", label: "Отрицательные отзывы на 10 000 чеков" }
        ];
      } else if (role === "povar") {
        fields = [
          { id: "baseRate", label: "Часовая ставка (₽)" },
          { id: "hours", label: "Длительность смены (часы)" },
          { id: "to", label: "Процент выполнения плана по ТО (%)" },
          { id: "povar_has_checklist", label: "Была ли проверка чек-листа?" },
          { id: "checklist", label: "Процент прохождения чек-листа Шеф-повара (%)" },
          { id: "povar_has_ovk", label: "Была ли проверка по униформе (ОВК)?" },
          { id: "ovk", label: "Процент проверки по униформе (ОВК) (%)" },
          { id: "povar_has_ato", label: "Была ли проверка АТО + СГИ?" },
          { id: "ato", label: "Процент прохождения АТО+СГИ (%)" }
        ];
      } else if (role === "others") {
        fields = [
          { id: "others_hourly_rate", label: "Часовая ставка (₽)" },
          { id: "others_shift_length", label: "Длительность смены (часы)" },
          { id: "others_to", label: "Товарооборот за день (₽)" },
          { id: "others_to_percent", label: "Процент выполнения плана по ТО (%)" },
          { id: "others_has_tp", label: "Была ли проверка от Тайного покупателя?" },
          { id: "others_tp", label: "Процент проверки Тайного покупателя (%)" },
          { id: "others_complaints", label: "Подтверждённые отрицательные отзывы" },
          { id: "others_has_ato", label: "Было ли прохождение АТО + СГИ?" },
          { id: "others_ato", label: "Процент прохождения АТО+СГИ (%)" },
          { id: "others_total_hours", label: "Общее количество часов команды (часы)" }
        ];
      } else if (role === "general") {
        fields = [
          { id: "general_rate", label: "Часовая ставка (₽)" },
          { id: "general_shifts", label: "Количество дней в месяце" },
          { id: "general_hours", label: "Часов в день" }
        ];
      }
      const roleText = document.querySelector('#roleCustom .custom-select-toggle').textContent;
      dataText.push(`Должность: ${roleText.trim()}`);
      dataText.push("Введённые данные:");
      let hasData = false;
      fields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input && input.value &&
            !(field.id === "others_tp" && document.getElementById("others_has_tp").value === "no") &&
            !(field.id === "others_ato" && document.getElementById("others_has_ato").value === "no") &&
            !(field.id === "checklist" && document.getElementById("povar_has_checklist").value === "no") &&
            !(field.id === "ovk" && document.getElementById("povar_has_ovk").value === "no") &&
            !(field.id === "ato" && document.getElementById("povar_has_ato").value === "no")) {
          let value = input.value;
          if (field.id === "hours" || field.id === "others_shift_length" || field.id === "general_hours") {
            value = parseFloat(value).toFixed(1);
          }
          dataText.push(`${field.label}: ${value}`);
          hasData = true;
        }
      });
      const resultDiv = document.getElementById("result");
      if (resultDiv.innerText && !resultDiv.innerText.includes("Ошибка") && !resultDiv.innerText.includes("Пожалуйста, выберите должность")) {
        dataText.push("");
        dataText.push("Результат расчёта:");
        const tmp = document.createElement('div');
        tmp.innerHTML = resultDiv.innerHTML;
        dataText.push(tmp.innerText.trim());
      }
      if (hasData || (resultDiv.innerText && !resultDiv.innerText.includes("Ошибка") && !resultDiv.innerText.includes("Пожалуйста, выберите должность"))) {
        try {
          const finalText = dataText.join('\n') + '\n';
          const textarea = document.createElement("textarea");
          textarea.value = finalText;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
          alert("Данные и результат скопированы в буфер обмена!");
        } catch (err) {
          alert("Ошибка при копировании данных.");
        }
      } else {
        alert("Нет данных или результата для копирования.");
      }
    }

    function calculateSalary() {
      const role = document.getElementById("role").value;
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (!role) {
        resultDiv.innerHTML = "<p style='color:red;'>Ошибка расчёта, проверьте введённые значения</p>";
        return;
      }

      let inputs = [];
      if (role === "zam") {
        inputs = ["zam_to","zam_tp","zam_ato","zam_hr","zam_feedback"].map(id=>$(id));
      } else if (role === "povar") {
        inputs = ["baseRate","hours","to","povar_has_checklist","checklist","povar_has_ovk","ovk","povar_has_ato","ato"].map(id=>$(id));
      } else if (role === "others") {
        inputs = ["others_hourly_rate","others_shift_length","others_to","others_to_percent","others_has_tp","others_tp","others_complaints","others_has_ato","others_ato","others_total_hours"].map(id=>$(id));
      } else if (role === "general") {
        inputs = ["general_rate","general_shifts","general_hours"].map(id=>$(id));
      }

      let hasError = false;
      for (const input of inputs) {
        if (!input) continue;
        if ((input.id === "others_has_tp" || input.id === "others_has_ato" || input.id === "povar_has_checklist" || input.id === "povar_has_ovk" || input.id === "povar_has_ato") && !input.value) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id !== "others_tp" && input.id !== "others_has_tp" && input.id !== "others_ato" && input.id !== "others_has_ato" && input.id !== "checklist" && input.id !== "povar_has_checklist" && input.id !== "ovk" && input.id !== "povar_has_ovk" && input.id !== "ato" && input.id !== "povar_has_ato" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id === "others_tp" && $("others_has_tp").value === "yes" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id === "others_ato" && $("others_has_ato").value === "yes" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id === "checklist" && $("povar_has_checklist").value === "yes" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id === "ovk" && $("povar_has_ovk").value === "yes" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else if (input.id === "ato" && $("povar_has_ato").value === "yes" && (!input.value || input.value === "" || parseFloat(input.value) < 0)) {
          input.classList.add('error');
          hasError = true;
        } else {
          input.classList.remove('error');
        }
      }

      if (hasError) {
        resultDiv.innerHTML = "<p style='color:red;'>Ошибка расчёта, проверьте введённые значения</p>";
        return;
      }

      let resultHTML = "";

      if (role === "zam") {
        const to = parseFloat($("zam_to").value);
        const tp = parseFloat($("zam_tp").value);
        const ato = parseFloat($("zam_ato").value);
        const hr = parseFloat($("zam_hr").value);
        const feedback = parseFloat($("zam_feedback").value);

        let bonusTO = to >= 95 && to < 98 ? 5000 : to >= 98 && to <= 102.9 ? 10000 : to > 102.9 ? 15000 : 0;
        let bonusTP = tp >= 85 && tp < 90 ? 1500 : tp >= 90 ? 3000 : 0;
        let bonusATO = ato >= 85 && ato <= 95 ? 1500 : ato > 95 ? 3000 : 0;
        let bonusHR = hr >= 80 && hr <= 85 ? 2000 : hr > 85 ? 4000 : 0;
        let bonusFeedback = feedback > 3 && feedback < 6 ? 1500 : feedback <= 3 ? 3000 : 0;

        const totalBonus = bonusTO + bonusTP + bonusATO + bonusHR + bonusFeedback;

        resultHTML = `
          <div class="result-section">
            <h3>Расчёт премий</h3>
            <div class="result-item"><span>Премия за ТО (% выполнения: ${to}%)</span><strong>${bonusTO.toFixed(0)} ₽</strong></div>
            <div class="result-calculation">${to >= 95 && to < 98 ? '≥ 95% и < 98% → 5000 ₽' : to >= 98 && to <= 102.9 ? '≥ 98% и ≤ 102.9% → 10000 ₽' : to > 102.9 ? '> 102.9% → 15000 ₽' : '< 95% → 0 ₽'}</div>
            <div class="result-item"><span>Премия за Тайного покупателя (%: ${tp}%)</span><strong>${bonusTP.toFixed(0)} ₽</strong></div>
            <div class="result-calculation">${tp >= 85 && tp < 90 ? '≥ 85% и < 90% → 1500 ₽' : tp >= 90 ? '≥ 90% → 3000 ₽' : '< 85% → 0 ₽'}</div>
            <div class="result-item"><span>Премия за АТО+СГИ (%: ${ato}%)</span><strong>${bonusATO.toFixed(0)} ₽</strong></div>
            <div class="result-calculation">${ato >= 85 && ato <= 95 ? '≥ 85% и ≤ 95% → 1500 ₽' : ato > 95 ? '> 95% → 3000 ₽' : '< 85% → 0 ₽'}</div>
            <div class="result-item"><span>Премия за HR-индекс (%: ${hr}%)</span><strong>${bonusHR.toFixed(0)} ₽</strong></div>
            <div class="result-calculation">${hr >= 80 && hr <= 85 ? '≥ 80% и ≤ 85% → 2000 ₽' : hr > 85 ? '> 85% → 4000 ₽' : '< 80% → 0 ₽'}</div>
            <div class="result-item"><span>Премия за отзывы (на 10 000 чеков: ${feedback})</span><strong>${bonusFeedback.toFixed(0)} ₽</strong></div>
            <div class="result-calculation">${feedback > 3 && feedback < 6 ? '> 3 и < 6 → 1500 ₽' : feedback <= 3 ? '≤ 3 → 3000 ₽' : '≥ 6 → 0 ₽'}</div>
          </div>
          <hr />
          <div class="result-total">Общая премия: <strong>${totalBonus.toFixed(0)} ₽</strong></div>
        `;
      } else if (role === "povar") {
        const baseRate = parseFloat($("baseRate").value);
        const to = parseFloat($("to").value);
        const checklist = $("povar_has_checklist").value === "yes" ? parseFloat($("checklist").value) : 0;
        const ovk = $("povar_has_ovk").value === "yes" ? parseFloat($("ovk").value) : 0;
        const ato = $("povar_has_ato").value === "yes" ? parseFloat($("ato").value) : 0;
        const hours = parseFloat($("hours").value);

        let bonusTO = to >= 95 && to <= 98 ? 10 : to > 98 ? 15 : 0;
        let bonusChecklist = checklist > 95 ? 15 : 0;
        let bonusOVK = ovk >= 100 ? 25 : 0;
        let bonusATO = ato >= 85 && ato <= 95 ? 15 : ato > 95 ? 25 : 0;

        const totalBonusPerHour = bonusTO + bonusChecklist + bonusOVK + bonusATO;
        const totalRate = baseRate + totalBonusPerHour;
        const totalPerShift = totalRate * hours;

        resultHTML = `
          <div class="result-section">
            <h3>Расчёт надбавок за час</h3>
            <div class="result-item"><span>Надбавка за ТО (% выполнения: ${to}%)</span><strong>${bonusTO.toFixed(0)} ₽/час</strong></div>
            <div class="result-calculation">${to >= 95 && to <= 98 ? '≥ 95% и ≤ 98% → 10 ₽/час' : to > 98 ? '> 98% → 15 ₽/час' : '< 95% → 0 ₽/час'}</div>
            <div class="result-item"><span>Надбавка за чек-лист (%: ${checklist}%)</span><strong>${bonusChecklist.toFixed(0)} ₽/час</strong></div>
            <div class="result-calculation">${checklist > 95 ? '> 95% → 15 ₽/час' : '≤ 95% или проверки не было → 0 ₽/час'}</div>
            <div class="result-item"><span>Надбавка за ОВК (%: ${ovk}%)</span><strong>${bonusOVK.toFixed(0)} ₽/час</strong></div>
            <div class="result-calculation">${ovk >= 100 ? '= 100% → 25 ₽/час' : '< 100% или проверки не было → 0 ₽/час'}</div>
            <div class="result-item"><span>Надбавка за АТО+СГИ (%: ${ato}%)</span><strong>${bonusATO.toFixed(0)} ₽/час</strong></div>
            <div class="result-calculation">${ato >= 85 && ato <= 95 ? '≥ 85% и ≤ 95% → 15 ₽/час' : ato > 95 ? '> 95% → 25 ₽/час' : '< 85% или проверки не было → 0 ₽/час'}</div>
          </div>
          <div class="result-section">
            <h3>Итоговый расчёт</h3>
            <div class="result-item"><span>Итоговая надбавка за час</span><strong>${totalBonusPerHour.toFixed(0)} ₽/час</strong></div>
            <div class="result-item"><span>Итоговая ставка за час</span><strong>${totalRate.toFixed(0)} ₽/час</strong></div>
            <div class="result-item"><span>Зарплата за смену (${hours.toFixed(1)} ч)</span><strong>${totalPerShift.toFixed(0)} ₽</strong></div>
          </div>
          <hr />
          <div class="result-total">Итоговая зарплата за смену: <strong>${totalPerShift.toFixed(0)} ₽</strong></div>
        `;
      } else if (role === "others") {
        const TO = parseFloat($("others_to").value);
        const TO_percent = parseFloat($("others_to_percent").value);
        const hasTP = $("others_has_tp").value;
        const TP = hasTP === "yes" ? parseFloat($("others_tp").value) : 0;
        const complaints = parseInt($("others_complaints").value);
        const hasATO = $("others_has_ato").value;
        const ATO = hasATO === "yes" ? parseFloat($("others_ato").value) : 0;
        const hourlyRate = parseFloat($("others_hourly_rate").value);
        const shiftLength = parseFloat($("others_shift_length").value);
        const totalHours = parseFloat($("others_total_hours").value);

        let coefTP = 1;
        if (hasTP === "yes") {
            if (TP < 80) { coefTP = 0.5; }
            else if (TP >= 80 && TP < 95) { coefTP = 1; }
            else if (TP >= 95) { coefTP = 2; }
        }

        let coefComplaints = complaints === 0 ? 1 : 0.75;

        let coefATO = 1;
        if (hasATO === "yes") {
            if (ATO < 85) { coefATO = 0.5; }
            else if (ATO >= 85 && ATO <= 95) { coefATO = 1; }
            else if (ATO > 95) { coefATO = 2; }
        }

        let fundTO = TO_percent <= 100 ? 0.009 * TO : 0.018 * TO;
        let fund = fundTO * coefTP * coefComplaints * coefATO;

        const salaryBase = hourlyRate * shiftLength;
        const personalBonus = (fund / totalHours) * shiftLength;
        const totalSalary = salaryBase + personalBonus;

        resultHTML = `
          <div class="result-section">
            <h3>Расчёт фонда премии</h3>
            <div class="result-item"><span>Базовый фонд от ТО (% выполнения: ${TO_percent}%)</span><strong>${fundTO.toFixed(0)} ₽</strong></div>
            <div class="result-item"><span>Коэффициент ТП (${hasTP === "yes" ? TP+'%' : 'не было'})</span><strong>${coefTP.toFixed(2)}</strong></div>
            <div class="result-item"><span>Коэффициент жалоб (${complaints})</span><strong>${coefComplaints.toFixed(2)}</strong></div>
            <div class="result-item"><span>Коэффициент АТО+СГИ (${hasATO === "yes" ? ATO+'%' : 'не было'})</span><strong>${coefATO.toFixed(2)}</strong></div>
            <div class="result-item"><span>Итоговый фонд</span><strong>${fund.toFixed(0)} ₽</strong></div>
          </div>
          <div class="result-section">
            <h3>Расчёт зарплаты</h3>
            <div class="result-item"><span>База за смену (${shiftLength.toFixed(1)} ч)</span><strong>${salaryBase.toFixed(0)} ₽</strong></div>
            <div class="result-item"><span>Доля из фонда (команда: ${totalHours} ч)</span><strong>${personalBonus.toFixed(0)} ₽</strong></div>
          </div>
          <hr />
          <div class="result-total">Итоговая зарплата за смену: <strong>${totalSalary.toFixed(0)} ₽</strong></div>
        `;
      } else if (role === "general") {
        const hourlyRate = parseFloat($("general_rate").value);
        const shifts = parseInt($("general_shifts").value);
        const hours = parseFloat($("general_hours").value);

        if (isNaN(hourlyRate) || isNaN(shifts) || isNaN(hours)) {
          resultHTML = "<p style='color:red;'>Пожалуйста, заполните все поля для расчёта.</p>";
        } else {
          const salary = hourlyRate * shifts * hours;
          resultHTML = `
            <div class="result-section">
              <h3>Параметры расчёта</h3>
              <div class="result-item"><span>Часовая ставка</span><strong>${hourlyRate.toFixed(0)} ₽/час</strong></div>
              <div class="result-item"><span>Количество смен</span><strong>${shifts}</strong></div>
              <div class="result-item"><span>Длительность смены</span><strong>${hours.toFixed(1)} ч</strong></div>
            </div>
            <hr />
            <div class="result-total">Итоговая зарплата за месяц: <strong>${salary.toFixed(0)} ₽</strong></div>
          `;
        }
      } else {
        resultHTML = "<p>Пожалуйста, выберите должность.</p>";
      }

      resultDiv.innerHTML = resultHTML;
    }

    /* КАСТОМНЫЙ SELECT: открытие, поиск, синхронизация (п.1) */
    function initCustomSelect(nativeId, wrapperId){
      const native = $(nativeId);
      const wrap = $(wrapperId);
      const btn = wrap.querySelector('.custom-select-toggle');
      const menu = wrap.querySelector('.custom-select-menu');
      const search = menu.querySelector('.custom-select-search input');
      const options = Array.from(menu.querySelectorAll('.custom-option'));

      function close(){ wrap.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      function open(){ wrap.classList.add('open'); btn.setAttribute('aria-expanded','true'); search.focus(); }

      btn.addEventListener('click', ()=> wrap.classList.contains('open') ? close() : open());
      document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) close(); });
      btn.addEventListener('keydown', (e)=>{ if((e.key==='ArrowDown'||e.key==='Enter'||e.key===' ')&&!wrap.classList.contains('open')){ e.preventDefault(); open(); } });

      options.forEach(opt=>{
        opt.addEventListener('click', ()=>{
          const val = opt.getAttribute('data-value') || '';
          options.forEach(o=>o.removeAttribute('aria-selected'));
          opt.setAttribute('aria-selected','true');
          btn.textContent = opt.textContent.trim();
          native.value = val;
          native.dispatchEvent(new Event('change', {bubbles:true}));
          close();
        });
      });

      search.addEventListener('input', ()=>{
        const q = search.value.toLowerCase().trim();
        options.forEach(o=>{
          const txt = o.textContent.toLowerCase();
          o.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }

    /* ПАНЕЛЬ ДЕЙСТВИЙ: показывать, когда основная кнопка вне экрана (п.3) */
    function initActionBar(){
      const bar = $('actionBar');
      const calcTop = $('calcTop');
      const calcBottom = $('calcBottom');
      const io = new IntersectionObserver(([entry])=>{
        bar.classList.toggle('visible', !entry.isIntersecting);
      }, {root:null, threshold:0, rootMargin:'0px'});
      io.observe(calcTop);
      calcBottom.addEventListener('click', ()=> calculateSalary());
    }

    /* Хедер и эффекты при скролле (п.7) */
    function initScrollEffects(){
      const onScroll = ()=>{
        if(window.scrollY > 6) document.body.classList.add('scrolled');
        else document.body.classList.remove('scrolled');
      };
      onScroll();
      window.addEventListener('scroll', onScroll, {passive:true});
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      mountHintButtonsInsideInputs();
      bindProgressiveReveal();

      // кастомный селект для роли
      initCustomSelect('role','roleCustom');

      // первичные значения слайдеров
      [['general_shifts','shiftValue',0],['general_hours','hoursValue',1],['hours','povarHoursValue',1],['others_shift_length','othersShiftValue',1]]
        .forEach(([sid,oid,dec])=>{const s=$(sid),o=$(oid);if(s&&o){o.textContent=dec?parseFloat(s.value).toFixed(1):s.value;}});

      // слушатели для Да/Нет
      Object.keys(deps).forEach(id=>{
        const el=$(id);
        if(el){ el.addEventListener('change', ()=>toggleDependent(id)); }
      });

      // UI улучшения
      initActionBar();
      initScrollEffects();
    });
  </script>

<script>
(function(){
  function sendHeight(){
    try{
      var h = Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight,
        document.documentElement.offsetHeight,
        document.body.offsetHeight
      );
      parent.postMessage({type:'salaryCalcHeight', height:h}, '*');
    }catch(e){}
  }
  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', function(){ requestAnimationFrame(sendHeight); });
  var mo = new MutationObserver(function(){ sendHeight(); });
  mo.observe(document.documentElement, {childList:true, subtree:true, attributes:true, characterData:true});
  setInterval(sendHeight, 1200);
})();
</script>

</body>
</html>
